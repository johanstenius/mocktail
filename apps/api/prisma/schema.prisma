generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Tier {
  free
  pro
  enterprise
}

enum OrgRole {
  owner
  admin
  member
}

model User {
  id            String          @id @default(cuid())
  email         String          @unique
  passwordHash  String
  createdAt     DateTime        @default(now())
  ownedOrgs     Organization[]  @relation("OrgOwner")
  memberships   OrgMembership[]
  refreshTokens RefreshToken[]
}

model Organization {
  id        String          @id @default(cuid())
  name      String
  slug      String          @unique
  ownerId   String
  tier      Tier            @default(free)
  createdAt DateTime        @default(now())
  owner     User            @relation("OrgOwner", fields: [ownerId], references: [id])
  members   OrgMembership[]
  projects  Project[]
  usage     UsageRecord[]
}

model OrgMembership {
  id        String       @id @default(cuid())
  userId    String
  orgId     String
  role      OrgRole
  createdAt DateTime     @default(now())
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  org       Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([userId, orgId])
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UsageRecord {
  id       String       @id @default(cuid())
  orgId    String
  year     Int
  month    Int
  apiCalls Int          @default(0)
  org      Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, year, month])
}

model Project {
  id        String       @id @default(cuid())
  name      String
  slug      String
  apiKey    String?
  orgId     String
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  org       Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  endpoints   Endpoint[]
  requestLogs RequestLog[]

  @@unique([orgId, slug])
}

model Endpoint {
  id          String   @id @default(cuid())
  projectId   String
  method      String   // GET, POST, PUT, DELETE, PATCH
  path        String   // /users, /users/:id
  status      Int      @default(200)
  headers     String   @default("{}") // JSON string
  body        String   @default("{}") // JSON string
  bodyType    String   @default("static") // "static" | "template"
  delay       Int      @default(0) // ms
  failRate    Int      @default(0) // 0-100 percentage
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  requestLogs RequestLog[]

  @@unique([projectId, method, path])
}

model RequestLog {
  id              String   @id @default(cuid())
  projectId       String
  endpointId      String?
  method          String
  path            String
  status          Int
  requestHeaders  String   @default("{}") // JSON string
  requestBody     String?
  responseBody    String?
  duration        Int      // ms
  createdAt       DateTime @default(now())

  project  Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  endpoint Endpoint? @relation(fields: [endpointId], references: [id], onDelete: SetNull)
}
