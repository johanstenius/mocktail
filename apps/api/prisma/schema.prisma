generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Tier {
  free
  pro
  enterprise
}

enum OrgRole {
  owner
  admin
  member
}

enum OAuthProvider {
  github
  google
}

enum AuditAction {
  // Org
  org_created
  org_updated
  // Members
  member_invited
  member_joined
  member_role_changed
  member_removed
  invite_cancelled
  // Projects
  project_created
  project_updated
  project_deleted
  api_key_rotated
  // Endpoints
  endpoint_created
  endpoint_updated
  endpoint_deleted
  // Variants
  variant_created
  variant_updated
  variant_deleted
  // Billing
  subscription_created
  subscription_updated
  subscription_cancelled
}

model User {
  id                     String                   @id @default(cuid())
  email                  String                   @unique
  passwordHash           String?
  name                   String?
  oauthProvider          OAuthProvider?
  oauthId                String?
  emailVerifiedAt        DateTime?
  hasCompletedOnboarding Boolean                  @default(false)
  onboardingCompletedAt  DateTime?
  createdAt              DateTime                 @default(now())
  ownedOrgs              Organization[]           @relation("OrgOwner")
  memberships            OrgMembership[]
  refreshTokens          RefreshToken[]
  passwordResets         PasswordResetToken[]
  emailVerifications     EmailVerificationToken[]
  auditLogs              AuditLog[]               @relation("AuditActor")

  @@unique([oauthProvider, oauthId])
}

model Organization {
  id                      String          @id @default(cuid())
  name                    String
  slug                    String          @unique
  ownerId                 String
  tier                    Tier            @default(free)
  createdAt               DateTime        @default(now())
  // Billing
  monthlyRequests         Int             @default(0)
  requestResetAt          DateTime?
  stripeCustomerId        String?         @unique
  stripeSubscriptionId    String?
  stripeCancelAtPeriodEnd Boolean         @default(false)
  stripeCurrentPeriodEnd  DateTime?
  paymentFailedAt         DateTime?
  lastFailedInvoiceId     String?
  // Relations
  owner                   User            @relation("OrgOwner", fields: [ownerId], references: [id])
  members                 OrgMembership[]
  projects                Project[]
  invites                 OrgInvite[]
  auditLogs               AuditLog[]
}

model OrgMembership {
  id        String       @id @default(cuid())
  userId    String
  orgId     String
  role      OrgRole
  createdAt DateTime     @default(now())
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  org       Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([userId, orgId])
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Project {
  id              String       @id @default(cuid())
  name            String
  slug            String
  apiKey          String       @unique
  orgId           String
  monthlyRequests Int          @default(0)
  requestResetAt  DateTime?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  org             Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  endpoints   Endpoint[]
  requestLogs RequestLog[]

  @@unique([orgId, slug])
}

model Endpoint {
  id        String   @id @default(cuid())
  projectId String
  method    String // GET, POST, PUT, DELETE, PATCH
  path      String // /users, /users/:id
  // Legacy fields - kept for backwards compat during migration
  status   Int?    @default(200)
  headers  String? @default("{}")
  body     String? @default("{}")
  bodyType String? @default("static")
  delay    Int?    @default(0)
  failRate Int?    @default(0)

  // Request validation
  requestBodySchema String @default("{}")
  validationMode    String @default("none")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project     Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  variants    ResponseVariant[]
  requestLogs RequestLog[]

  @@unique([projectId, method, path])
}

model ResponseVariant {
  id         String  @id @default(cuid())
  endpointId String
  name       String  @default("Default")
  priority   Int     @default(0) // Lower = higher priority
  isDefault  Boolean @default(false)

  // Response config
  status   Int    @default(200)
  headers  String @default("{}") // JSON string
  body     String @default("{}") // JSON string
  bodyType String @default("static") // "static" | "template"
  delay    Int    @default(0) // ms
  failRate Int    @default(0) // 0-100 percentage

  // Match rules
  rules     String @default("[]") // JSON: MatchRule[]
  ruleLogic String @default("and") // "and" | "or"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  endpoint Endpoint @relation(fields: [endpointId], references: [id], onDelete: Cascade)

  @@index([endpointId, priority])
}

model RequestLog {
  id               String   @id @default(cuid())
  projectId        String
  endpointId       String?
  variantId        String? // Which variant was matched
  method           String
  path             String
  status           Int
  requestHeaders   String   @default("{}") // JSON string
  requestBody      String?
  responseBody     String?
  validationErrors String? // JSON array of error messages
  duration         Int // ms
  createdAt        DateTime @default(now())

  project  Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  endpoint Endpoint? @relation(fields: [endpointId], references: [id], onDelete: SetNull)
}


model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
}

model OrgInvite {
  id        String       @id @default(cuid())
  email     String
  orgId     String
  role      OrgRole      @default(member)
  token     String       @unique
  expiresAt DateTime
  invitedBy String
  createdAt DateTime     @default(now())
  org       Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([email, orgId])
}

model BatchJob {
  id        String    @id @default(cuid())
  type      String
  status    String    // running, completed, failed
  result    String?   // JSON summary
  error     String?
  startedAt DateTime  @default(now())
  endedAt   DateTime?

  @@index([type])
  @@index([startedAt])
}

model AuditLog {
  id         String      @id @default(cuid())
  orgId      String
  actorId    String?
  action     AuditAction
  targetType String?
  targetId   String?
  metadata   String      @default("{}")
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime    @default(now())

  org   Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  actor User?        @relation("AuditActor", fields: [actorId], references: [id], onDelete: SetNull)

  @@index([orgId, createdAt])
  @@index([actorId])
  @@index([action])
}
